{% extends 'user_base.html' %}
{% load static %}
{% block content %}

    <div class="container mt-4 p-4 bg-dark text-white rounded">
        <h1 class="mb-4">Add Batch</h1>

        <form method="post" class="needs-validation" novalidate>
            {% csrf_token %}

            <div class="mb-4">
                <h2 class="h4 mb-3">Batch Details</h2>
                <div class="card bg-secondary mb-3">
                    <div class="card-body">
                        {{ batch_form.as_p }}
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h2 class="h4 mb-3">Ingredients</h2>
                {{ ingredient_formset.management_form }}
                <div id="ingredient-formset">
                    {% for form in ingredient_formset %}
                        <div class="card bg-secondary mb-3 ingredient-form">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <label for="{{ form.ingredient.id_for_label }}"
                                               class="form-label">Ingredient:</label>
                                        {{ form.ingredient }}
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <label for="{{ form.new_ingredient.id_for_label }}" class="form-label">New
                                            Ingredient:</label>
                                        {{ form.new_ingredient }}
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label for="{{ form.amount.id_for_label }}" class="form-label">Amount:</label>
                                        {{ form.amount }}
                                    </div>
                                    <div class="col-md-2 mb-2">
                                        <label for="{{ form.unit.id_for_label }}" class="form-label">Unit:</label>
                                        {{ form.unit }}
                                    </div>

                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" id="add-ingredient" class="btn btn-info mt-2">Add More Ingredients</button>
            </div>

            <div class="mb-4">
                <h2 class="h4 mb-3">Add Process Entry</h2>
                <div class="card bg-secondary mb-3">
                    <div class="card-body">
                        {{ process_form.as_p }}
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">Save Batch</button>
                <a href="{% url 'main:list_batches' %}" class="btn btn-secondary">Back to Batch List</a>
            </div>
        </form>
    </div>

    <style>
        .card-body input,
        .card-body select,
        .card-body textarea {
            width: 100%;
            padding: 0.375rem 0.75rem;
            background-color: #495057;
            border: 1px solid #ced4da;
            color: #fff;
        }

        .card-body label {
            color: #fff;
            margin-bottom: 0.25rem;
        }

        .card-body {
            padding: 1rem;
        }
    </style>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script>
        $(document).ready(function () {
            let formCount = {{ ingredient_formset.total_form_count }};
            let formsetPrefix = "{{ ingredient_formset.prefix }}";

            $('#add-ingredient').click(function () {
                let form = $('.ingredient-form:first').clone(true);
                form.find('input').val('');
                form.find('select').prop('selectedIndex', 0);
                form.find(':checkbox').prop('checked', false);

                // Update form index
                form.find(':input').each(function () {
                    let name = $(this).attr('name').replace('-0-', '-' + formCount + '-');
                    let id = 'id_' + name;
                    $(this).attr({'name': name, 'id': id}).val('').removeAttr('checked');
                });

                form.find('label').each(function () {
                    let forAttr = $(this).attr('for');
                    if (forAttr) {
                        let newFor = forAttr.replace('-0-', '-' + formCount + '-');
                        $(this).attr('for', newFor);
                    }
                });

                $('#ingredient-formset').append(form);
                formCount++;

                // Update management form
                $('#id_' + formsetPrefix + '-TOTAL_FORMS').val(formCount);
            });

            // Enable dynamic removal of ingredient forms
            $(document).on('change', 'input[id$=DELETE]', function () {
                if ($(this).is(':checked')) {
                    $(this).closest('.ingredient-form').hide();
                } else {
                    $(this).closest('.ingredient-form').show();
                }
            });
        });
    </script>
{% endblock %}